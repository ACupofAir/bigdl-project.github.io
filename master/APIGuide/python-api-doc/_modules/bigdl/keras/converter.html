
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>bigdl.keras.converter &#8212; BigDL  documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">BigDL  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for bigdl.keras.converter</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Copyright 2016 The BigDL Authors.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">bigdl.nn.layer</span> <span class="k">as</span> <span class="nn">BLayer</span>
<span class="kn">import</span> <span class="nn">bigdl.util.common</span> <span class="k">as</span> <span class="nn">BCommon</span>
<span class="kn">from</span> <span class="nn">bigdl.util.common</span> <span class="k">import</span> <span class="n">get_activation_by_name</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">model_from_json</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">Sequential</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">Layer</span>
<span class="kn">import</span> <span class="nn">keras</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">bigdl.keras.ToBigDLHelper</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="unsupport_exp"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.unsupport_exp">[docs]</a><span class="k">def</span> <span class="nf">unsupport_exp</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support </span><span class="si">%s</span><span class="s2"> for now&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="WeightLoader"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightLoader">[docs]</a><span class="k">class</span> <span class="nc">WeightLoader</span><span class="p">:</span>

    <span class="c1"># TODO: add more unitest</span>
    <span class="c1"># bmodel and kmodel should have the same layers.</span>
    <span class="c1"># and this method should only be called when bmodel is generated by kmodel</span>
<div class="viewcode-block" id="WeightLoader.load_weights_from_kmodel"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightLoader.load_weights_from_kmodel">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_weights_from_kmodel</span><span class="p">(</span><span class="n">bmodel</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">):</span>
        <span class="n">keras_name_to_layer</span> <span class="o">=</span> <span class="n">WeightLoader</span><span class="o">.</span><span class="n">__keras_name_to_Layers</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">with_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">bigdl_name_to_layer</span> <span class="o">=</span> <span class="n">WeightLoader</span><span class="o">.</span><span class="n">__bigdl_name_to_Layers</span><span class="p">(</span><span class="n">bmodel</span><span class="p">,</span> <span class="n">with_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># klayer should be just a layer, not seq, not Model</span>
        <span class="k">for</span> <span class="n">klayer</span> <span class="ow">in</span> <span class="n">keras_name_to_layer</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">klayer</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">bigdl_name_to_layer</span><span class="p">:</span>
                <span class="n">blayer</span> <span class="o">=</span> <span class="n">bigdl_name_to_layer</span><span class="p">[</span><span class="n">klayer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="n">bigdl_weights</span> <span class="o">=</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">get_bigdl_weights_from_klayer</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
                <span class="n">blayer</span><span class="o">.</span><span class="n">set_weights</span><span class="p">(</span><span class="n">bigdl_weights</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">BatchNormalization</span><span class="p">):</span>
                    <span class="n">blayer</span><span class="o">.</span><span class="n">set_running_mean</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="n">running_mean</span><span class="p">))</span>
                    <span class="n">blayer</span><span class="o">.</span><span class="n">set_running_std</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="n">running_std</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;should not enter here, klayer: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">klayer</span><span class="p">)</span></div>

<div class="viewcode-block" id="WeightLoader.load_weights_from_json_hdf5"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightLoader.load_weights_from_json_hdf5">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_weights_from_json_hdf5</span><span class="p">(</span><span class="n">def_json</span><span class="p">,</span> <span class="n">weights_hdf5</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The file path can be stored in a local file system, HDFS, S3,</span>
<span class="sd">        or any Hadoop-supported file system.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bmodel</span> <span class="o">=</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_json_path</span><span class="p">(</span><span class="n">def_json</span><span class="p">)</span>
        <span class="n">def_value</span> <span class="o">=</span> <span class="n">BCommon</span><span class="o">.</span><span class="n">text_from_path</span><span class="p">(</span><span class="n">def_json</span><span class="p">)</span>
        <span class="n">kmodel</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="n">def_value</span><span class="p">)</span>
        <span class="n">WeightLoader</span><span class="o">.</span><span class="n">load_weights_from_hdf5</span><span class="p">(</span><span class="n">bmodel</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">,</span> <span class="n">weights_hdf5</span><span class="p">,</span> <span class="n">by_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bmodel</span></div>


<div class="viewcode-block" id="WeightLoader.load_weights_from_hdf5"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightLoader.load_weights_from_hdf5">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_weights_from_hdf5</span><span class="p">(</span><span class="n">bmodel</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Loads all layer weights from a HDF5 save file.</span>
<span class="sd">        filepath can be stored in a local file system, HDFS, S3,</span>
<span class="sd">        or any Hadoop-supported file system.</span>
<span class="sd">        If `by_name` is False (default) weights are loaded</span>
<span class="sd">        based on the network&#39;s execution order topology,</span>
<span class="sd">        meaning layers in the execution seq should be exactly the same</span>
<span class="sd">        the architecture</span>

<span class="sd">        If `by_name` is True, weights are loaded into layers</span>
<span class="sd">        only if they share the same name. This is useful</span>
<span class="sd">        for fine-tuning or transfer-learning models where</span>
<span class="sd">        some of the layers have changed.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">local_file_path</span> <span class="o">=</span> <span class="n">BCommon</span><span class="o">.</span><span class="n">get_local_file</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">kmodel</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">local_file_path</span><span class="p">,</span> <span class="n">by_name</span><span class="o">=</span><span class="n">by_name</span><span class="p">)</span>
        <span class="n">WeightLoader</span><span class="o">.</span><span class="n">load_weights_from_kmodel</span><span class="p">(</span><span class="n">bmodel</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__keras_name_to_Layers</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">with_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">total_layers</span> <span class="o">=</span> <span class="n">DefinitionLoader</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">node_id_to_layer</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">with_weights</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">total_layers</span>
                      <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">)]</span>  <span class="c1"># noqa</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">total_layers</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Model</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">)]</span>  <span class="c1"># noqa</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__bigdl_name_to_Layers</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">with_weights</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># NB: Container in BigDL is_with_weights() is true if one of the nested layer with_weights</span>
        <span class="c1"># but in Keras container get_weights() return false even if the nested layer with_weights</span>
        <span class="n">all_layers</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">flattened_layers</span><span class="p">(</span><span class="n">include_container</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">with_weights</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">all_layers</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">is_with_weights</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">layers</span> <span class="o">=</span> <span class="n">all_layers</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">layer</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">])</span></div>


<div class="viewcode-block" id="WeightsConverter"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter">[docs]</a><span class="k">class</span> <span class="nc">WeightsConverter</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert keras weights to bigdl weights</span>
<span class="sd">    The shape of weights would be changed if using different backend,</span>
<span class="sd">    so we only test against TensorFlow backend.</span>
<span class="sd">    TODO: Support th backend as well.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WeightsConverter.get_converter"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.get_converter">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_converter</span><span class="p">(</span><span class="n">class_name</span><span class="p">):</span>
        <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;convert_&quot;</span> <span class="o">+</span> <span class="n">class_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">WeightsConverter</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">unsupport_exp</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
        <span class="n">converter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">WeightsConverter</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">converter</span></div>

<div class="viewcode-block" id="WeightsConverter.to_bigdl_weights"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.to_bigdl_weights">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="c1"># weights is a list of ndarray or a ndarray</span>
    <span class="c1"># convert keras weights per layer to bigdl format</span>
    <span class="k">def</span> <span class="nf">to_bigdl_weights</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">get_converter</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="WeightsConverter.get_bigdl_weights_from_klayer"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.get_bigdl_weights_from_klayer">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_bigdl_weights_from_klayer</span><span class="p">(</span><span class="n">klayer</span><span class="p">):</span>
        <span class="c1"># we should use get_weights instead of klayer.weights</span>
        <span class="k">return</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">to_bigdl_weights</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">klayer</span><span class="o">.</span><span class="n">get_weights</span><span class="p">())</span></div>

<div class="viewcode-block" id="WeightsConverter.get_weights_from_kmodel"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.get_weights_from_kmodel">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_weights_from_kmodel</span><span class="p">(</span><span class="n">kmodel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert kmodel&#39;s weights to bigdl format.</span>
<span class="sd">        We are supposing the order is the same as the execution order.</span>
<span class="sd">        :param kmodel: keras model</span>
<span class="sd">        :return: list of ndarray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">layers_with_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">layer</span> <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">kmodel</span><span class="o">.</span><span class="n">layers</span> <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">weights</span><span class="p">]</span>
        <span class="n">bweights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">klayer</span> <span class="ow">in</span> <span class="n">layers_with_weights</span><span class="p">:</span>
            <span class="c1"># bws would be [weights, bias] or [weights]</span>
            <span class="n">bws</span> <span class="o">=</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">get_bigdl_weights_from_klayer</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">bws</span><span class="p">:</span>
                <span class="n">bweights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bweights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_timedistributed"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_timedistributed">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_timedistributed</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">to_bigdl_weights</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_bidirectional"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_bidirectional">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_bidirectional</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">kweights_forward</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[:</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">kweights_backward</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">):]</span>
        <span class="n">bweights_forward</span> <span class="o">=</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">to_bigdl_weights</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">kweights_forward</span><span class="p">)</span>
        <span class="n">bweights_backward</span> <span class="o">=</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">to_bigdl_weights</span><span class="p">(</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="n">kweights_backward</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bweights_forward</span> <span class="o">+</span> <span class="n">bweights_backward</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_dense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_dense">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_dense</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_timedistributeddense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_timedistributeddense">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_timedistributeddense</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_batchnormalization"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_batchnormalization">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_batchnormalization</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="n">beta</span><span class="p">]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_atrousconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_atrousconvolution2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_atrousconvolution2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_atrousconvolution1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_atrousconvolution1d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_atrousconvolution1d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_deconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_deconvolution2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_deconvolution2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weight</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weight</span><span class="p">]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_convolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_convolution2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_convolution2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># bigdl has a leading dim with value 1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weight</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weight</span><span class="p">]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_convolution1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_convolution1d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_convolution1d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">WeightsConverter</span><span class="o">.</span><span class="n">convert_convolution2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_convolution3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_convolution3d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_convolution3d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_embedding"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_embedding">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_embedding</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_simplernn"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_simplernn">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_simplernn</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_lstm"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_lstm">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_lstm</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">11</span><span class="p">]))</span>
        <span class="n">w3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_convlstm2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_convlstm2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_convlstm2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span> <span class="n">weights</span><span class="p">[</span><span class="mi">11</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span> <span class="mi">0</span><span class="p">)]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_gru"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_gru">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_gru</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">w1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">w2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
        <span class="n">w3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">weights</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="n">w4</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">,</span> <span class="n">w4</span><span class="p">]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_highway"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_highway">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_highway</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if without bias</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_maxoutdense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_maxoutdense">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_maxoutdense</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">k_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">b_weights</span> <span class="o">=</span> <span class="n">k_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">b_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">b_weights</span><span class="p">,</span> <span class="n">k_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if without bias</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">b_weights</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">b_weights</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">k_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">k_weights</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">)]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_srelu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_srelu">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_srelu</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_separableconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_separableconvolution2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_separableconvolution2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># if without bias</span>
            <span class="k">if</span> <span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bias</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="p">)]</span>
        <span class="k">return</span> <span class="n">weights</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_locallyconnected1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_locallyconnected1d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_locallyconnected1d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">bweights1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if without bias</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">bweights1</span><span class="p">]</span>
        <span class="k">return</span><span class="p">[</span><span class="n">bweights1</span><span class="p">,</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span></div>

<div class="viewcode-block" id="WeightsConverter.convert_locallyconnected2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.WeightsConverter.convert_locallyconnected2d">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">convert_locallyconnected2d</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">bweights1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># if without bias</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">bweights1</span><span class="p">]</span>
        <span class="n">bweights2</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">weights</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span><span class="p">[</span><span class="n">bweights1</span><span class="p">,</span> <span class="n">bweights2</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="DefinitionLoader"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.DefinitionLoader">[docs]</a><span class="k">class</span> <span class="nc">DefinitionLoader</span><span class="p">:</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__build_node_id_2_klayer</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">node_id_to_config_layer</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The result would contain all of the layers including nested layers.</span>
<span class="sd">        :param kmodel: a keras model which can be Sequential or Model</span>
<span class="sd">        :param node_id_to_config_layer: a container to store the result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">kmodel</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmodel</span>  <span class="c1"># include itself as well</span>
        <span class="k">def</span> <span class="nf">gather_result</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">layers</span><span class="p">:</span>  <span class="c1"># layers maybe None here.</span>
                <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_id_to_config_layer</span><span class="p">:</span>
                        <span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer</span>
                        <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">__build_node_id_2_klayer</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">node_id_to_config_layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">):</span>
            <span class="n">gather_result</span><span class="p">(</span><span class="n">kmodel</span><span class="o">.</span><span class="n">layers</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="s2">&quot;flattened_layers&quot;</span><span class="p">):</span>
            <span class="n">gather_result</span><span class="p">(</span><span class="n">kmodel</span><span class="o">.</span><span class="n">flattened_layers</span><span class="p">)</span>  <span class="c1"># it&#39;s a expensive operation</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__build_node_id_2_kclayer</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">node_id_to_config_layer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">layer_config</span> <span class="ow">in</span> <span class="n">kmodel</span><span class="o">.</span><span class="n">get_config</span><span class="p">():</span>
                <span class="n">layer_name</span> <span class="o">=</span> <span class="n">layer_config</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">][</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                <span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">layer_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">layer_config</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">layerConfig</span> <span class="ow">in</span> <span class="n">kmodel</span><span class="o">.</span><span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;layers&quot;</span><span class="p">]:</span>
                <span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">layerConfig</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">layerConfig</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">kmodel</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmodel</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;should not enter here: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">kmodel</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_layer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_config_layer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span> <span class="o">=</span> <span class="n">kmodel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kconfig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>

        <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">__build_node_id_2_klayer</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_layer</span><span class="p">)</span>
        <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">__build_node_id_2_kclayer</span><span class="p">(</span><span class="n">kmodel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_config_layer</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__to_bigdl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Sequential</span><span class="p">):</span>
            <span class="n">bigdlmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_bigdl_sequence</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Model</span><span class="p">):</span>
            <span class="n">bigdlmodel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_bigdl_model</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="p">,</span> <span class="n">Layer</span><span class="p">):</span>
            <span class="n">bigdlmodel</span> <span class="o">=</span> <span class="n">LayerConverter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Should not enter here: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bigdlmodel</span>

<div class="viewcode-block" id="DefinitionLoader.from_kmodel"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.DefinitionLoader.from_kmodel">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_kmodel</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">kmodel</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">kmodel</span><span class="p">)</span><span class="o">.</span><span class="n">__to_bigdl</span><span class="p">()</span></div>

<div class="viewcode-block" id="DefinitionLoader.from_hdf5_path"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.DefinitionLoader.from_hdf5_path">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_hdf5_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">hdf5_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param hdf5_path: hdf5 path which can be stored in a local file system, HDFS, S3, or any Hadoop-supported file system.</span>
<span class="sd">        :return: BigDL Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">keras.models</span> <span class="k">import</span> <span class="n">load_model</span>
        <span class="n">hdf5_local_path</span> <span class="o">=</span> <span class="n">BCommon</span><span class="o">.</span><span class="n">get_local_file</span><span class="p">(</span><span class="n">hdf5_path</span><span class="p">)</span>
        <span class="n">kmodel</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="n">hdf5_local_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kmodel</span><span class="p">,</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_kmodel</span><span class="p">(</span><span class="n">kmodel</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefinitionLoader.from_json_path"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.DefinitionLoader.from_json_path">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json_path</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param json_path: definition path which can be stored in a local file system, HDFS, S3, or any Hadoop-supported file system.</span>
<span class="sd">        :return: BigDL Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_str</span> <span class="o">=</span> <span class="n">BCommon</span><span class="o">.</span><span class="n">text_from_path</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_json_str</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="DefinitionLoader.from_json_str"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.DefinitionLoader.from_json_str">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json_str</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_str</span><span class="p">):</span>
        <span class="n">kmodel</span> <span class="o">=</span> <span class="n">model_from_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_kmodel</span><span class="p">(</span><span class="n">kmodel</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_do_create_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="n">clayer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">clayer</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;InputLayer&quot;</span><span class="p">:</span>
            <span class="nb">input</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Input</span><span class="p">()</span>
            <span class="nb">input</span><span class="o">.</span><span class="n">element</span><span class="p">()</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># cannot set name for node?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">input</span>
            <span class="k">return</span> <span class="nb">input</span>
        <span class="n">bigdl_in_nodes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">clayer</span><span class="p">[</span><span class="s2">&quot;inbound_nodes&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">out</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">out_name</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">out_index</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">out_tensor_index</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">out_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_do_create_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_layer</span><span class="p">[</span><span class="n">out_name</span><span class="p">],</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">out_name</span><span class="p">])</span>
                <span class="n">bigdl_in_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">[</span><span class="n">out_name</span><span class="p">])</span>

        <span class="n">blayer</span> <span class="o">=</span> <span class="n">LayerConverter</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">clayer</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">new_bnode</span> <span class="o">=</span> <span class="n">blayer</span><span class="p">(</span><span class="n">bigdl_in_nodes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_bnode</span>
        <span class="k">return</span> <span class="n">new_bnode</span>

    <span class="k">def</span> <span class="nf">_construct_bigdl_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">clayer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;layers&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">clayer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_do_create_node</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_layer</span><span class="p">[</span><span class="n">clayer</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]],</span>
                                     <span class="n">clayer</span><span class="p">)</span>
        <span class="n">ins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;input_layers&quot;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">input_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="n">outs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output_layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kconfig</span><span class="p">[</span><span class="s2">&quot;output_layers&quot;</span><span class="p">]:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">output_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">outs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_instance</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">ins</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">outs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_bigdl_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bseq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kmodel</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="c1"># recursive logic is within create method.</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">LayerConverter</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_id_to_config_layer</span><span class="p">[</span><span class="n">layer</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
            <span class="n">bseq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bseq</span></div>

<div class="viewcode-block" id="LayerConverter"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter">[docs]</a><span class="k">class</span> <span class="nc">LayerConverter</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">,</span> <span class="n">kclayer</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span> <span class="o">=</span> <span class="n">klayer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span> <span class="o">=</span> <span class="n">kclayer</span>
        <span class="k">if</span> <span class="s2">&quot;config&quot;</span> <span class="ow">in</span> <span class="n">kclayer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_shape</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">klayer</span><span class="o">.</span><span class="n">get_input_shape_at</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">input_shape</span>

    <span class="k">def</span> <span class="nf">__check_is_share_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For Merge layer len(kclayer[&quot;inbound_nodes&quot;]) is equal to 1</span>
        <span class="c1"># &quot;inbound_nodes&quot;: [</span>
        <span class="c1">#                      [</span>
        <span class="c1">#                          [</span>
        <span class="c1">#                              &quot;batchnormalization_194&quot;,</span>
        <span class="c1">#                              0,</span>
        <span class="c1">#                              0</span>
        <span class="c1">#                          ],</span>
        <span class="c1">#                          [</span>
        <span class="c1">#                              &quot;batchnormalization_196&quot;,</span>
        <span class="c1">#                              0,</span>
        <span class="c1">#                              0</span>
        <span class="c1">#                          ],</span>
        <span class="c1">#                          [</span>
        <span class="c1">#                              &quot;batchnormalization_199&quot;,</span>
        <span class="c1">#                              0,</span>
        <span class="c1">#                              0</span>
        <span class="c1">#                          ],</span>
        <span class="c1">#                          [</span>
        <span class="c1">#                              &quot;batchnormalization_200&quot;,</span>
        <span class="c1">#                              0,</span>
        <span class="c1">#                              0</span>
        <span class="c1">#                          ]</span>
        <span class="c1">#                      ]</span>
        <span class="c1">#                  ],</span>
        <span class="k">if</span> <span class="s2">&quot;inbound_nodes&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;inbound_nodes&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> doesn&#39;t support multiple inputs with shared weights&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">])</span>

<div class="viewcode-block" id="LayerConverter.create"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__check_is_share_weights</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;b_constraint&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">b_constraint</span><span class="p">)</span> <span class="ow">or</span> \
           <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;W_constraint&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">W_constraint</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support constraint for now&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;activity_regularizer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">activity_regularizer</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support activity_regularizer for now&quot;</span><span class="p">)</span>

        <span class="n">function_name</span> <span class="o">=</span> <span class="s2">&quot;create_&quot;</span> <span class="o">+</span> <span class="n">class_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support layer: </span><span class="si">%s</span><span class="s2"> for now&quot;</span> <span class="o">%</span> <span class="n">class_name</span> <span class="p">)</span>

        <span class="n">blayer_creator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">blayer_creator</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">blayer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_model"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_model">[docs]</a>    <span class="k">def</span> <span class="nf">create_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_kmodel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_sequential"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_sequential">[docs]</a>    <span class="k">def</span> <span class="nf">create_sequential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_kmodel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_inputlayer"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_inputlayer">[docs]</a>    <span class="k">def</span> <span class="nf">create_inputlayer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span></div>

<div class="viewcode-block" id="LayerConverter.create_dense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_dense">[docs]</a>    <span class="k">def</span> <span class="nf">create_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Multiple inputs should share the same input_dim for Dense layer</span>
        <span class="c1"># We don&#39;t need to respect the tensor index for method `get_input_shape_at`</span>
        <span class="c1"># which is internal implementation and `get_input_shape_at` has hided that for us,</span>
        <span class="c1"># What we need to use is the input index, not node index, not tensor index.</span>

        <span class="n">out_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dim&quot;</span><span class="p">]</span>
        <span class="n">in_dim</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="n">in_dim</span><span class="p">,</span>
            <span class="n">output_size</span><span class="o">=</span><span class="n">out_dim</span><span class="p">,</span>
            <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">InferReshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">InferReshape</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">[</span><span class="n">out_dim</span><span class="p">],</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_timedistributeddense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_timedistributeddense">[docs]</a>    <span class="k">def</span> <span class="nf">create_timedistributeddense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span>
            <span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">output_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_dim&quot;</span><span class="p">],</span>
            <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">])</span>
        <span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_timedistributed"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_timedistributed">[docs]</a>    <span class="k">def</span> <span class="nf">create_timedistributed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># input_shape is (batch, time, other dims)</span>
        <span class="n">inner_input_shape</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">LayerConverter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span> <span class="n">inner_input_shape</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">TimeDistributed</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_bidirectional"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_bidirectional">[docs]</a>    <span class="k">def</span> <span class="nf">create_bidirectional</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only return_sequences=True is supported for RNNs for now&quot;</span><span class="p">)</span>
        <span class="n">recurrent_name</span> <span class="o">=</span> <span class="s2">&quot;generate_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;_cell&quot;</span>

        <span class="n">recurrent_creator</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recurrent_name</span><span class="p">)</span>
        <span class="n">recurrent</span> <span class="o">=</span> <span class="n">recurrent_creator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;layer&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">merge_mode</span> <span class="o">==</span> <span class="s2">&quot;concat&quot;</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">JoinTable</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">merge_mode</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CAddTable</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">merge_mode</span> <span class="o">==</span> <span class="s2">&quot;mul&quot;</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CMulTable</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">merge_mode</span> <span class="o">==</span> <span class="s2">&quot;ave&quot;</span><span class="p">:</span>
            <span class="n">merge</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CAveTable</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid merge mode: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">merge_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">BiRecurrent</span><span class="p">(</span><span class="n">merge</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">recurrent</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_embedding"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_embedding">[docs]</a>    <span class="k">def</span> <span class="nf">create_embedding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">input_length</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">input_length</span> <span class="o">!=</span> <span class="n">seq_len</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;The input_length doesn&#39;t match: </span><span class="si">%s</span><span class="s2"> vs </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">input_length</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;dropout&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dropout</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support dropout for now&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;mask_zero&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mask_zero</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support mask_zero for now&quot;</span><span class="p">)</span>

        <span class="n">bseq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">LookupTable</span><span class="p">(</span>
                 <span class="n">n_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">input_dim</span><span class="p">,</span>
                 <span class="n">n_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
                 <span class="n">padding_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">norm_type</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                 <span class="n">should_scale_grad_by_freq</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">bseq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">AddConstant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">))</span>  <span class="c1"># Add 1 as BigDL is one-based index</span>
        <span class="n">bseq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">blayer</span><span class="o">.</span><span class="n">set_init_method</span><span class="p">(</span><span class="n">to_bigdl_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">bseq</span></div>

<div class="viewcode-block" id="LayerConverter.create_activation"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_activation">[docs]</a>    <span class="k">def</span> <span class="nf">create_activation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># SoftMax is different between Keras and BigDL for 3D inputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;softmax&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Transpose</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]))</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Transpose</span><span class="p">([(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]))</span>
            <span class="k">return</span> <span class="n">model</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_dropout"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_dropout">[docs]</a>    <span class="k">def</span> <span class="nf">create_dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_flatten"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_flatten">[docs]</a>    <span class="k">def</span> <span class="nf">create_flatten</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))],</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_permute"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_permute">[docs]</a>    <span class="k">def</span> <span class="nf">create_permute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">swaps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__perm_to_pair</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dims</span><span class="p">))</span>
        <span class="n">swaps</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">swaps</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="n">swaps</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Transpose</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">swaps</span><span class="p">))</span></div>

    <span class="k">def</span> <span class="nf">__perm_to_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perm</span><span class="p">):</span>
        <span class="c1"># perm: a list as a permutation of [1..n], eg [3, 1, 2] for n=3.</span>
        <span class="c1"># return a list of tuples that needs to be swapped to obtain the input `perm`.</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">low</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">high</span>
            <span class="n">pivot</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">low</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">high</span> <span class="o">-</span> <span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)]</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">pivot</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">while</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pivot</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">j</span><span class="p">:</span>
                    <span class="n">exchangeNumbers</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">:</span>
                <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">:</span>
                <span class="n">sort</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">exchangeNumbers</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
            <span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>
            <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">sort</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">pair</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pairs</span><span class="p">))</span>

<div class="viewcode-block" id="LayerConverter.create_reshape"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_reshape">[docs]</a>    <span class="k">def</span> <span class="nf">create_reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">target_shape</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">InferReshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">target_shape</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">target_shape</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_repeatvector"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_repeatvector">[docs]</a>    <span class="k">def</span> <span class="nf">create_repeatvector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Replicate</span><span class="p">(</span><span class="n">n_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                                <span class="n">n_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__is_from_sequential</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;layers&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;layers&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>  <span class="c1"># noqa</span>

<div class="viewcode-block" id="LayerConverter.create_merge"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_merge">[docs]</a>    <span class="k">def</span> <span class="nf">create_merge</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_shape</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_shape</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only output_shape=None or a shape tuple is supported for now&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">node_indices</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">node_indices</span><span class="p">):</span>
            <span class="n">unsupport_exp</span><span class="p">(</span><span class="s2">&quot;node_indices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_mask</span><span class="p">:</span>
            <span class="n">unsupport_exp</span><span class="p">(</span><span class="s2">&quot;output_mask&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;concat&quot;</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">JoinTable</span><span class="p">(</span>
                <span class="n">dimension</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">concat_axis</span><span class="p">,</span>
                <span class="n">n_input_dims</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CAddTable</span><span class="p">(</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;mul&quot;</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CMulTable</span><span class="p">(</span><span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CMaxTable</span><span class="p">(</span><span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;dot&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For merge mode dot, 3D input or above is not supported for now.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dot_axes</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For merge mode dot, only dot_axes=1 is supported for now.&quot;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">DotProduct</span><span class="p">(</span><span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">))</span>\
                <span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ave&quot;</span><span class="p">:</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">CAveTable</span><span class="p">(</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cos&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For merge mode cos, 3D input or above is not supported for now.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dot_axes</span> <span class="o">!=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For merge mode cos, only dot_axes=1 is supported for now.&quot;</span><span class="p">)</span>
            <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
            <span class="n">blayer</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">CosineDistance</span><span class="p">(</span><span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># invalid mode or lambda functions</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid merge mode: `</span><span class="si">%s</span><span class="s2">`. Lambda/function as merge mode is not supported for now.&quot;</span>
                            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_from_sequential</span><span class="p">():</span>
            <span class="n">bseq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
            <span class="n">parallel_table</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">ParallelTable</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
                <span class="n">bl</span> <span class="o">=</span> <span class="n">DefinitionLoader</span><span class="o">.</span><span class="n">from_kmodel</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                <span class="n">parallel_table</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">bl</span><span class="p">)</span>
            <span class="n">bseq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">parallel_table</span><span class="p">)</span>
            <span class="n">bseq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bseq</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_elu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_elu">[docs]</a>    <span class="k">def</span> <span class="nf">create_elu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">ELU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">alpha</span><span class="p">),</span>
                          <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                          <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_prelu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_prelu">[docs]</a>    <span class="k">def</span> <span class="nf">create_prelu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">PReLU</span><span class="p">(</span><span class="n">n_output_plane</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_leakyrelu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_leakyrelu">[docs]</a>    <span class="k">def</span> <span class="nf">create_leakyrelu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">LeakyReLU</span><span class="p">(</span><span class="n">negval</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">alpha</span><span class="p">),</span>
                                <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_parametricsoftplus"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_parametricsoftplus">[docs]</a>    <span class="k">def</span> <span class="nf">create_parametricsoftplus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">alpha_init</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">beta_init</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">shared_axes</span> <span class="o">!=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="n">unsupport_exp</span><span class="p">(</span><span class="s2">&quot;shared_axes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">round</span><span class="p">(</span><span class="n">alpha</span> <span class="o">*</span> <span class="n">beta</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SoftPlus</span><span class="p">(</span><span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                                   <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only alpha_init = 1/beta_init is supported for now&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_thresholdedrelu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_thresholdedrelu">[docs]</a>    <span class="k">def</span> <span class="nf">create_thresholdedrelu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Threshold</span><span class="p">(</span><span class="n">th</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">theta</span><span class="p">),</span>
                                <span class="n">v</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                <span class="n">ip</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__generate_zeropadding1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pad_top</span><span class="p">,</span> <span class="n">pad_bottom</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialZeroPadding</span><span class="p">(</span><span class="n">pad_left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">pad_right</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">pad_top</span><span class="o">=</span><span class="n">pad_top</span><span class="p">,</span>
                                         <span class="n">pad_bottom</span><span class="o">=</span><span class="n">pad_bottom</span><span class="p">,</span>
                                         <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="LayerConverter.create_zeropadding1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_zeropadding1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_zeropadding1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">padding</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding1d</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="n">padding</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding1d</span><span class="p">(</span><span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;left_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;right_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># tuple of int (length 2)</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding1d</span><span class="p">(</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">__generate_zeropadding2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">,</span> <span class="n">n_input_dim</span><span class="p">,</span> <span class="n">pad1</span><span class="p">,</span> <span class="n">pad2</span><span class="p">,</span> <span class="n">pad3</span><span class="p">,</span> <span class="n">pad4</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">paddinglayer1</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim1</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">pad1</span><span class="p">,</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer2</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim1</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">pad2</span><span class="p">,</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer3</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim2</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">pad3</span><span class="p">,</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer4</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim2</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">pad4</span><span class="p">,</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="n">n_input_dim</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer1</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer2</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer3</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer4</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span>

    <span class="c1"># NB: zeropadding doesn&#39;t serialize dim_ording to json file</span>
<div class="viewcode-block" id="LayerConverter.create_zeropadding2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_zeropadding2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_zeropadding2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">padding</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;dim_ordering&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot find dim_ordering from json definition. Using the default instead.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">padding</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># dictionary</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                 <span class="o">-</span><span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;top_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bottom_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                 <span class="o">-</span><span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;left_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">padding</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;right_pad&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># tuple of int</span>
            <span class="n">padding</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">padding</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__generate_zeropadding2d</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                                     <span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">-</span><span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">padding</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span></div>

    <span class="c1"># NB: zeropadding doesn&#39;t serialize dim_ording to json file</span>
<div class="viewcode-block" id="LayerConverter.create_zeropadding3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_zeropadding3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_zeropadding3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s2">&quot;dim_ordering&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot find dim_ordering from json definition. Using the default instead.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">paddinglayer1</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=-</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer2</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">padding</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer3</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=-</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer4</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">padding</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer5</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=-</span><span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">paddinglayer6</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Padding</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="n">dim</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">pad</span><span class="o">=</span><span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                       <span class="n">n_input_dim</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                       <span class="n">value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                       <span class="n">n_index</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer1</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer2</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer3</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer4</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer5</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">paddinglayer6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">model</span></div>

<div class="viewcode-block" id="LayerConverter.create_cropping1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_cropping1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_cropping1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cropping</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialZeroPadding</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">cropping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="n">cropping</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="LayerConverter.create_cropping2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_cropping2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_cropping2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Cropping2D</span><span class="p">(</span><span class="n">heightCrop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">widthCrop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_cropping3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_cropping3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_cropping3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">(</span><span class="s2">&quot;3D&quot;</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Cropping3D</span><span class="p">(</span><span class="n">dim1Crop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">dim2Crop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">dim3Crop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">cropping</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                   <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

    <span class="k">def</span> <span class="nf">__check_recurrent_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">klayer</span><span class="o">.</span><span class="n">stateful</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only stateful=False for recurrent layers is supported for now&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">klayer</span><span class="p">,</span> <span class="s2">&quot;consume_less&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">klayer</span><span class="o">.</span><span class="n">consume_less</span> <span class="o">==</span> <span class="s2">&quot;gpu&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;consume_less=gpu is not supported for now&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__process_recurrent_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_sequences</span><span class="p">,</span> <span class="n">go_backwards</span><span class="p">,</span> <span class="n">blayer</span><span class="p">):</span>
        <span class="c1"># For recurrent layers,</span>
        <span class="c1"># handle whether to return the last output sentence or the full sequence;</span>
        <span class="c1"># handle whether the input will go backwards</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">go_backwards</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reverse</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_sequences</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">model</span>

<div class="viewcode-block" id="LayerConverter.generate_simplernn_cell"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.generate_simplernn_cell">[docs]</a>    <span class="k">def</span> <span class="nf">generate_simplernn_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">,</span> <span class="n">kclayer</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>  <span class="c1"># create a simplernn cell only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_recurrent_parameters</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
        <span class="n">rnn</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">RnnCell</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                             <span class="n">hidden_size</span><span class="o">=</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
                             <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                             <span class="n">isInputWithBias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                             <span class="n">uRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;U_regularizer&quot;</span><span class="p">]),</span>
                             <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                             <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rnn</span></div>

<div class="viewcode-block" id="LayerConverter.create_simplernn"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_simplernn">[docs]</a>    <span class="k">def</span> <span class="nf">create_simplernn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Recurrent</span><span class="p">()</span>
        <span class="n">rnn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_simplernn_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__process_recurrent_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rnn</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.generate_lstm_cell"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.generate_lstm_cell">[docs]</a>    <span class="k">def</span> <span class="nf">generate_lstm_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">,</span> <span class="n">kclayer</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>  <span class="c1"># create a lstm cell only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_recurrent_parameters</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
        <span class="n">inner_activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">],</span>
                                                  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">]))</span>
        <span class="n">lstm</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                           <span class="n">hidden_size</span><span class="o">=</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
                           <span class="n">p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                           <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                           <span class="n">inner_activation</span><span class="o">=</span><span class="n">inner_activation</span><span class="p">,</span>
                           <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                           <span class="n">uRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;U_regularizer&quot;</span><span class="p">]),</span>
                           <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                           <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lstm</span></div>

<div class="viewcode-block" id="LayerConverter.create_lstm"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_lstm">[docs]</a>    <span class="k">def</span> <span class="nf">create_lstm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Recurrent</span><span class="p">()</span>
        <span class="n">lstm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_lstm_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__process_recurrent_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lstm</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.generate_convlstm2d_cell"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.generate_convlstm2d_cell">[docs]</a>    <span class="k">def</span> <span class="nf">generate_convlstm2d_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">,</span> <span class="n">kclayer</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>  <span class="c1"># create a convlstm2d cell only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_recurrent_parameters</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
        <span class="n">inner_activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">],</span>
                                                  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">]))</span>

        <span class="n">convlstm</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">ConvLSTMPeephole</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                           <span class="n">output_size</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_filter&quot;</span><span class="p">],</span>
                                           <span class="n">kernel_i</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_col&quot;</span><span class="p">],</span>
                                           <span class="n">kernel_c</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_row&quot;</span><span class="p">],</span>
                                           <span class="c1"># NB: ConvLSTM doesn&#39;t serialize subsample to json file</span>
                                           <span class="n">stride</span><span class="o">=</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">padding</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                                           <span class="n">inner_activation</span><span class="o">=</span><span class="n">inner_activation</span><span class="p">,</span>
                                           <span class="c1"># NB: ConvLSTM doesn&#39;t serialize regularizers to json file</span>
                                           <span class="c1"># wRegularizer=to_bigdl_reg(config[&quot;W_regularizer&quot;]),</span>
                                           <span class="c1"># uRegularizer=to_bigdl_reg(config[&quot;U_regularizer&quot;]),</span>
                                           <span class="c1"># bRegularizer=to_bigdl_reg(config[&quot;b_regularizer&quot;]),</span>
                                           <span class="n">cRegularizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                           <span class="n">with_peephole</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                           <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">convlstm</span></div>

<div class="viewcode-block" id="LayerConverter.create_convlstm2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_convlstm2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_convlstm2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># TODO: border_mode = &#39;valid&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_mode&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported border_mode: valid&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span>
                            <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_row&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_col&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only square kernel is supported for now. Please set nb_row=nb_col.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only equal stride is supported for now. &quot;</span>
                            <span class="s2">&quot;Please set subsample to be a tuple with equal values.&quot;</span><span class="p">)</span>

        <span class="n">rec</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Recurrent</span><span class="p">()</span>
        <span class="n">convlstm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_convlstm2d_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__process_recurrent_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">convlstm</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.generate_gru_cell"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.generate_gru_cell">[docs]</a>    <span class="k">def</span> <span class="nf">generate_gru_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">klayer</span><span class="p">,</span> <span class="n">kclayer</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>  <span class="c1"># create a gru cell only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_recurrent_parameters</span><span class="p">(</span><span class="n">klayer</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">kclayer</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span>
        <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
        <span class="n">inner_activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">],</span>
                                                  <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;inner_activation&quot;</span><span class="p">]))</span>
        <span class="n">gru</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                         <span class="n">hidden_size</span><span class="o">=</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
                         <span class="n">p</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                         <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                         <span class="n">inner_activation</span><span class="o">=</span><span class="n">inner_activation</span><span class="p">,</span>
                         <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                         <span class="n">uRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;U_regularizer&quot;</span><span class="p">]),</span>
                         <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                         <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gru</span></div>

<div class="viewcode-block" id="LayerConverter.create_gru"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_gru">[docs]</a>    <span class="k">def</span> <span class="nf">create_gru</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Recurrent</span><span class="p">()</span>
        <span class="n">gru</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_gru_cell</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kclayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__process_recurrent_layer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">return_sequences</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">go_backwards</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">gru</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.create_batchnormalization"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_batchnormalization">[docs]</a>    <span class="k">def</span> <span class="nf">create_batchnormalization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only 4D input is supported for now, but the current input dim is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_dim_ordering</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">axis</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;For BatchNormalization with th image ordering, we only support &quot;&quot;&quot;</span> <span class="o">+</span>
                            <span class="sd">&quot;&quot;&quot;axis = 1 for now, but the current axis is %s</span>
<span class="sd">                            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>  <span class="c1"># noqa</span>
        <span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_dim_ordering</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;tf&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">axis</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;For BatchNormalization with tf image ordering, we only support &quot;&quot;&quot;</span> <span class="o">+</span>
                            <span class="sd">&quot;&quot;&quot;axis = -1 for now, but the current axis is %s</span>
<span class="sd">                            &quot;&quot;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Only support mode = 0 for now, but the current mode is: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gamma_regularizer&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support gamma_regularizer for now&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;beta_regularizer&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support beta_regularizer for now&quot;</span><span class="p">)</span>

        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="n">to_bigdl_2d_ordering</span><span class="p">(</span><span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_dim_ordering</span><span class="p">())</span>
        <span class="n">n_input_channel</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">axis</span><span class="p">])</span>

        <span class="c1"># init gamma and beta</span>
        <span class="c1"># TODO: replace this with to_bigdl_init in the future</span>
        <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">gamma_init</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">n_input_channel</span><span class="p">,))</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_value_from_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">beta_init</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">n_input_channel</span><span class="p">,))</span>

        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialBatchNormalization</span><span class="p">(</span>
                 <span class="n">n_output</span><span class="o">=</span><span class="n">n_input_channel</span><span class="p">,</span>
                 <span class="n">eps</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
                 <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">momentum</span><span class="p">,</span>
                 <span class="n">affine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">init_weight</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                 <span class="n">init_bias</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span>
                 <span class="n">init_grad_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_grad_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="n">k_running_mean</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">running_mean</span><span class="p">)</span>
        <span class="n">k_running_std</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">running_std</span><span class="p">)</span>
        <span class="n">blayer</span><span class="o">.</span><span class="n">set_running_mean</span><span class="p">(</span><span class="n">k_running_mean</span><span class="p">)</span>
        <span class="n">blayer</span><span class="o">.</span><span class="n">set_running_std</span><span class="p">(</span><span class="n">k_running_std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.get_bdim_order"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.get_bdim_order">[docs]</a>    <span class="k">def</span> <span class="nf">get_bdim_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;2D&quot;</span><span class="p">):</span>  <span class="c1"># get bigdl dim_ordering from keras dim_ordering</span>
        <span class="k">if</span> <span class="s2">&quot;dim_ordering&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;dim_ordering&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot find dim_ordering from json definition. Using the default instead.&quot;</span><span class="p">)</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">image_dim_ordering</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dim</span> <span class="o">==</span> <span class="s2">&quot;3D&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">to_bigdl_3d_ordering</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_bigdl_2d_ordering</span><span class="p">(</span><span class="n">order</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_convolution1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_convolution1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_convolution1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># batch, steps, dim, batch is None here, so you cannot use it directly.</span>
        <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialConvolution</span><span class="p">(</span>
                 <span class="n">n_input_plane</span><span class="o">=</span><span class="n">stack_size</span><span class="p">,</span>
                 <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
                 <span class="n">kernel_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">kernel_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">filter_length</span><span class="p">,</span>
                 <span class="n">stride_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">stride_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample_length</span><span class="p">,</span>
                 <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                 <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                 <span class="n">n_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">propagate_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                 <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                 <span class="n">init_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_grad_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_grad_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
                 <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">,</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_convolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_convolution2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_convolution2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NHWC&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialConvolution</span><span class="p">(</span>
                 <span class="n">n_input_plane</span><span class="o">=</span><span class="n">stack_size</span><span class="p">,</span>
                 <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
                 <span class="n">kernel_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_col</span><span class="p">,</span>
                 <span class="n">kernel_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_row</span><span class="p">,</span>
                 <span class="n">stride_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">stride_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                 <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                 <span class="n">n_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">propagate_back</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                 <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                 <span class="n">init_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_grad_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">init_grad_bias</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
                 <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_convolution3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_convolution3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_convolution3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>

        <span class="n">bpadT</span><span class="p">,</span> <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_3d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">VolumetricConvolution</span><span class="p">(</span>
            <span class="n">n_input_plane</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
            <span class="n">k_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">kernel_dim1</span><span class="p">,</span>
            <span class="n">k_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">kernel_dim3</span><span class="p">,</span>
            <span class="n">k_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">kernel_dim2</span><span class="p">,</span>
            <span class="n">d_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">d_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="n">d_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">pad_t</span><span class="o">=</span><span class="n">bpadT</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
            <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">],</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_atrousconvolution1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_atrousconvolution1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_atrousconvolution1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only bias=True is supported for AtrousConvolution1D&quot;</span><span class="p">)</span>

        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;filter_length&quot;</span><span class="p">]</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsample_length&quot;</span><span class="p">]</span>
        <span class="n">dilation_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;atrous_rate&quot;</span><span class="p">]</span>
        <span class="n">pad_h</span><span class="p">,</span> <span class="n">pad_w</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_mode&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">dilation_h</span><span class="p">)</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Transpose</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialDilatedConvolution</span><span class="p">(</span>
            <span class="n">n_input_plane</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_filter&quot;</span><span class="p">],</span>
            <span class="n">kw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="n">dh</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">pad_w</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">pad_h</span><span class="p">,</span>
            <span class="n">dilation_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dilation_h</span><span class="o">=</span><span class="n">dilation_h</span><span class="p">,</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Transpose</span><span class="p">([(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_atrousconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_atrousconvolution2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_atrousconvolution2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;bias&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Only bias=True is supported for AtrousConvolution2D&quot;</span><span class="p">)</span>

        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_row&quot;</span><span class="p">]</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_col&quot;</span><span class="p">]</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsample&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsample&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dilation_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;atrous_rate&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dilation_w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;atrous_rate&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pad_h</span><span class="p">,</span> <span class="n">pad_w</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_mode&quot;</span><span class="p">],</span> <span class="n">h</span><span class="p">,</span> <span class="n">kh</span><span class="p">,</span> <span class="n">dh</span><span class="p">,</span> <span class="n">dilation_h</span><span class="p">,</span>
                                                <span class="n">w</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">dilation_w</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialDilatedConvolution</span><span class="p">(</span>
            <span class="n">n_input_plane</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_filter&quot;</span><span class="p">],</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">kw</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="n">dw</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="n">dh</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">pad_w</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">pad_h</span><span class="p">,</span>
            <span class="n">dilation_w</span><span class="o">=</span><span class="n">dilation_w</span><span class="p">,</span>
            <span class="n">dilation_h</span><span class="o">=</span><span class="n">dilation_h</span><span class="p">,</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_deconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_deconvolution2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_deconvolution2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="n">output_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;output_shape&quot;</span><span class="p">]</span>

        <span class="n">h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">kh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_row&quot;</span><span class="p">]</span>
        <span class="n">kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nb_col&quot;</span><span class="p">]</span>
        <span class="n">dh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsample&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">dw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;subsample&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">output_h</span> <span class="o">=</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">output_w</span> <span class="o">=</span> <span class="n">output_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">pad_w</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pad_h</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;border_mode&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span><span class="p">:</span>
            <span class="n">two_pad_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dh</span> <span class="o">+</span> <span class="n">kh</span> <span class="o">-</span> <span class="n">output_h</span>  <span class="c1"># 2 times pad_h</span>
            <span class="n">two_pad_w</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dw</span> <span class="o">+</span> <span class="n">kw</span> <span class="o">-</span> <span class="n">output_w</span>  <span class="c1"># 2 times pad_w</span>
            <span class="k">if</span> <span class="n">two_pad_h</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># we only support pad_h as an int</span>
                <span class="n">pad_h</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">two_pad_h</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For same padding, we only support padding on both sides for now. &quot;</span>
                                <span class="s2">&quot;Please make `(input_row - 1) * subsample[0] + nb_row - output_row` an even integer.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">two_pad_w</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># we only support pad_w as an int</span>
                <span class="n">pad_w</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">two_pad_w</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;For same padding, we only support padding on both sides for now. &quot;</span>
                                <span class="s2">&quot;Please make `(input_col - 1) * subsample[1] + nb_col - output_col` an even integer.&quot;</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialFullConvolution</span><span class="p">(</span>
            <span class="n">n_input_plane</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
            <span class="n">kw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_col</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_row</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">pad_w</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">pad_h</span><span class="p">,</span>
            <span class="n">adj_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">adj_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">n_group</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">no_bias</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_maxpooling3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_maxpooling3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_maxpooling3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="c1"># TODO: border_mode = &#39;same&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span> <span class="o">==</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported border_mode: same&quot;</span><span class="p">)</span>

        <span class="n">bpadT</span><span class="p">,</span> <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_3d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">VolumetricMaxPooling</span><span class="p">(</span>
                <span class="n">k_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">k_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">k_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">d_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">d_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">d_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">pad_t</span><span class="o">=</span><span class="n">bpadT</span><span class="p">,</span>
                <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_maxpooling2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_maxpooling2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_maxpooling2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialMaxPooling</span><span class="p">(</span>
                 <span class="n">kw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">kh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">dw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">dh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                 <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                 <span class="n">to_ceil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="nb">format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
                 <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalmaxpooling3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalmaxpooling3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalmaxpooling3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="n">b_kt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for dim_ordering. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">VolumetricMaxPooling</span><span class="p">(</span>
                <span class="n">k_t</span><span class="o">=</span><span class="n">b_kt</span><span class="p">,</span>
                <span class="n">k_w</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
                <span class="n">k_h</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
                <span class="n">d_t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">d_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">d_h</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">pad_t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalaveragepooling3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalaveragepooling3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalaveragepooling3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">==</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="n">b_kt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for dim_ordering. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">VolumetricAveragePooling</span><span class="p">(</span>
                <span class="n">k_t</span><span class="o">=</span><span class="n">b_kt</span><span class="p">,</span>
                <span class="n">k_w</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
                <span class="n">k_h</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
                <span class="n">d_t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">d_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">d_h</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">pad_t</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_averagepooling2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_averagepooling2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_averagepooling2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialAveragePooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">kh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">dw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">dh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
            <span class="n">global_pooling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_averagepooling3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_averagepooling3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_averagepooling3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use `th` for `dim_ordering`. `</span><span class="si">%s</span><span class="s2">` is not supported for now.&quot;</span> <span class="o">%</span> <span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="c1"># TODO: border_mode = &#39;same&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span> <span class="o">==</span> <span class="s1">&#39;same&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unsupported border_mode: same&quot;</span><span class="p">)</span>

        <span class="n">bpadT</span><span class="p">,</span> <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_3d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">VolumetricAveragePooling</span><span class="p">(</span>
                <span class="n">k_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">k_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">k_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">d_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">d_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">d_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">strides</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">pad_t</span><span class="o">=</span><span class="n">bpadT</span><span class="p">,</span>
                <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalmaxpooling2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalmaxpooling2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalmaxpooling2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialMaxPooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">to_ceil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalmaxpooling1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalmaxpooling1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalmaxpooling1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b_kw</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialMaxPooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">to_ceil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalaveragepooling1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalaveragepooling1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalaveragepooling1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b_kw</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialAveragePooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">global_pooling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_maxpooling1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_maxpooling1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_maxpooling1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialMaxPooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_length</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
            <span class="n">to_ceil</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_averagepooling1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_averagepooling1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_averagepooling1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialAveragePooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">pool_length</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">stride</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
            <span class="n">global_pooling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_globalaveragepooling2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_globalaveragepooling2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_globalaveragepooling2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_kw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">b_kh</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialAveragePooling</span><span class="p">(</span>
            <span class="n">kw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">kh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">dw</span><span class="o">=</span><span class="n">b_kw</span><span class="p">,</span>
            <span class="n">dh</span><span class="o">=</span><span class="n">b_kh</span><span class="p">,</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">global_pooling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ceil_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">count_include_pad</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">divide</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
            <span class="n">bigdl_type</span><span class="o">=</span><span class="s2">&quot;float&quot;</span>
        <span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
            <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_input_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_upsampling1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_upsampling1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_upsampling1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">UpSampling1D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">length</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_upsampling2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_upsampling2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_upsampling2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">UpSampling2D</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                   <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_upsampling3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_upsampling3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_upsampling3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span> <span class="o">!=</span> <span class="s2">&quot;th&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please use th for dim_ordering. </span><span class="si">%s</span><span class="s2"> is not supported for now.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">dim_ordering</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;dim_ordering&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot find dim_ordering from json definition. Using the default instead.&quot;</span>
                          <span class="s2">&quot;We only support th for now.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">UpSampling3D</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">size</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_gaussiannoise"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_gaussiannoise">[docs]</a>    <span class="k">def</span> <span class="nf">create_gaussiannoise</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">GaussianNoise</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">sigma</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.create_gaussiandropout"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_gaussiandropout">[docs]</a>    <span class="k">def</span> <span class="nf">create_gaussiandropout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">GaussianDropout</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">p</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.create_highway"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_highway">[docs]</a>    <span class="k">def</span> <span class="nf">create_highway</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Highway</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                                <span class="n">activation</span><span class="o">=</span><span class="n">activation</span><span class="p">,</span>
                                <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                                <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_maxoutdense"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_maxoutdense">[docs]</a>    <span class="k">def</span> <span class="nf">create_maxoutdense</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Maxout</span><span class="p">(</span><span class="n">input_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                               <span class="n">output_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">output_dim</span><span class="p">,</span>
                               <span class="n">maxout_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_feature</span><span class="p">,</span>
                               <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                               <span class="n">w_regularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                               <span class="n">b_regularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_masking"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_masking">[docs]</a>    <span class="k">def</span> <span class="nf">create_masking</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Masking</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">mask_value</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.create_srelu"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_srelu">[docs]</a>    <span class="k">def</span> <span class="nf">create_srelu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;shared_axes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Cannot find shared_axes from json definition. Using shared_axes=None instead.&quot;</span><span class="p">)</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">t_left_init</span> <span class="o">=</span> <span class="n">to_bigdl_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;t_left_init&quot;</span><span class="p">])</span>
        <span class="n">a_left_init</span> <span class="o">=</span> <span class="n">to_bigdl_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;a_left_init&quot;</span><span class="p">])</span>
        <span class="n">t_right_init</span> <span class="o">=</span> <span class="n">to_bigdl_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;t_right_init&quot;</span><span class="p">])</span>
        <span class="n">a_right_init</span> <span class="o">=</span> <span class="n">to_bigdl_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;a_right_init&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">shared_axes</span> <span class="o">==</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
            <span class="n">srelu</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SReLU</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">srelu</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SReLU</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">shared_axes</span><span class="p">)</span>

        <span class="n">srelu</span><span class="o">.</span><span class="n">set_init_method</span><span class="p">(</span><span class="n">t_left_init</span><span class="p">,</span> <span class="n">a_left_init</span><span class="p">,</span> <span class="n">t_right_init</span><span class="p">,</span> <span class="n">a_right_init</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">srelu</span></div>

<div class="viewcode-block" id="LayerConverter.create_separableconvolution2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_separableconvolution2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_separableconvolution2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">keras</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">backend</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;tensorflow&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Please use tensorflow backend for keras 1.2.2 &#39;</span>
                            <span class="s1">&#39;if you want to load SeparableConv2D&#39;</span><span class="p">)</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NHWC&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialSeperableConvolution</span><span class="p">(</span>
            <span class="n">n_input_channel</span><span class="o">=</span><span class="n">stack_size</span><span class="p">,</span>
            <span class="n">n_output_channel</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
            <span class="n">depth_multiplier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">depth_multiplier</span><span class="p">,</span>
            <span class="n">kernel_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_col</span><span class="p">,</span>
            <span class="n">kernel_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_row</span><span class="p">,</span>
            <span class="n">stride_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">stride_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
            <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
            <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
            <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">,</span>
            <span class="n">w_regularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;depthwise_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">b_regularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
            <span class="n">p_regularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;pointwise_regularizer&quot;</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">combo_parameter_layer</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_activityregularization"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_activityregularization">[docs]</a>    <span class="k">def</span> <span class="nf">create_activityregularization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">ActivityRegularization</span><span class="p">(</span><span class="n">l1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">l2</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.create_spatialdropout1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_spatialdropout1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_spatialdropout1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialDropout1D</span><span class="p">(</span><span class="n">init_p</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">p</span><span class="p">))</span></div>

<div class="viewcode-block" id="LayerConverter.create_spatialdropout2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_spatialdropout2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_spatialdropout2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialDropout2D</span><span class="p">(</span><span class="n">init_p</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">p</span><span class="p">),</span>
                                         <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_spatialdropout3d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_spatialdropout3d">[docs]</a>    <span class="k">def</span> <span class="nf">create_spatialdropout3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">SpatialDropout3D</span><span class="p">(</span><span class="n">init_p</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">p</span><span class="p">),</span>
                                         <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.create_locallyconnected1d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_locallyconnected1d">[docs]</a>    <span class="k">def</span> <span class="nf">create_locallyconnected1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Reshape</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="kc">True</span><span class="p">))</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">LocallyConnected2D</span><span class="p">(</span><span class="n">n_input_plane</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                                           <span class="n">input_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">input_height</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                                           <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
                                           <span class="n">kernel_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">kernel_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">filter_length</span><span class="p">,</span>
                                           <span class="n">stride_w</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                           <span class="n">stride_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample_length</span><span class="p">,</span>
                                           <span class="n">pad_w</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">pad_h</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                                           <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                                           <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                                           <span class="n">data_format</span><span class="o">=</span><span class="s2">&quot;NHWC&quot;</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">BLayer</span><span class="o">.</span><span class="n">Squeeze</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuse</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">activation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">seq</span></div>

<div class="viewcode-block" id="LayerConverter.create_locallyconnected2d"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.create_locallyconnected2d">[docs]</a>    <span class="k">def</span> <span class="nf">create_locallyconnected2d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bigdl_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bdim_order</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NCHW&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">input_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">input_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">bigdl_order</span> <span class="o">==</span> <span class="s2">&quot;NHWC&quot;</span><span class="p">:</span>
            <span class="n">stack_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">input_width</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">input_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">bpadW</span><span class="p">,</span> <span class="n">bpadH</span> <span class="o">=</span> <span class="n">to_bigdl_2d_padding</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">border_mode</span><span class="p">)</span>
        <span class="n">blayer</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">LocallyConnected2D</span><span class="p">(</span><span class="n">n_input_plane</span><span class="o">=</span><span class="n">stack_size</span><span class="p">,</span>
                                           <span class="n">input_width</span><span class="o">=</span><span class="n">input_width</span><span class="p">,</span>
                                           <span class="n">input_height</span><span class="o">=</span><span class="n">input_height</span><span class="p">,</span>
                                           <span class="n">n_output_plane</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_filter</span><span class="p">,</span>
                                           <span class="n">kernel_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_col</span><span class="p">,</span>
                                           <span class="n">kernel_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">nb_row</span><span class="p">,</span>
                                           <span class="n">stride_w</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                           <span class="n">stride_h</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">subsample</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="n">pad_w</span><span class="o">=</span><span class="n">bpadW</span><span class="p">,</span>
                                           <span class="n">pad_h</span><span class="o">=</span><span class="n">bpadH</span><span class="p">,</span>
                                           <span class="n">wRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;W_regularizer&quot;</span><span class="p">]),</span>
                                           <span class="n">bRegularizer</span><span class="o">=</span><span class="n">to_bigdl_reg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;b_regularizer&quot;</span><span class="p">]),</span>
                                           <span class="n">with_bias</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">klayer</span><span class="o">.</span><span class="n">bias</span><span class="p">,</span>
                                           <span class="n">data_format</span><span class="o">=</span><span class="n">bigdl_order</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuse</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="n">activation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.combo_parameter_layer"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.combo_parameter_layer">[docs]</a>    <span class="k">def</span> <span class="nf">combo_parameter_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blayer</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">blayer</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="s2">&quot;set_init_method&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">blayer</span><span class="o">.</span><span class="n">set_init_method</span><span class="p">(</span><span class="n">to_bigdl_init</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]),</span>
                                       <span class="n">BInit</span><span class="o">.</span><span class="n">Zeros</span><span class="p">())</span>  <span class="c1"># Keras always set this to be zeros</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">warning_msg</span> <span class="o">=</span> <span class="s2">&quot;We don&#39;t support initialization &quot;</span> <span class="o">+</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; for now. &quot;</span> \
                    <span class="o">+</span> <span class="s2">&quot;Using the default instead.&quot;</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_msg</span><span class="p">)</span>
        <span class="c1"># &quot;linear&quot; means doing nothing</span>
        <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">activation</span> <span class="o">=</span> <span class="n">get_activation_by_name</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">],</span>
                                                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;activation&quot;</span><span class="p">]))</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fuse</span><span class="p">(</span><span class="n">blayer</span><span class="p">,</span> <span class="n">activation</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">blayer</span></div>

<div class="viewcode-block" id="LayerConverter.get_value_from_init"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.get_value_from_init">[docs]</a>    <span class="k">def</span> <span class="nf">get_value_from_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kinit_method</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kinit_method</span> <span class="o">==</span> <span class="s2">&quot;zero&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">kinit_method</span> <span class="o">==</span> <span class="s2">&quot;one&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;We don&#39;t support </span><span class="si">% f</span><span class="s2">or now&quot;</span><span class="p">,</span> <span class="n">kinit_method</span><span class="p">)</span></div>

<div class="viewcode-block" id="LayerConverter.fuse"><a class="viewcode-back" href="../../../bigdl.keras.html#bigdl.keras.converter.LayerConverter.fuse">[docs]</a>    <span class="k">def</span> <span class="nf">fuse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_blayer</span><span class="p">,</span> <span class="n">activation</span><span class="p">):</span>  <span class="c1"># activation is a layer</span>
        <span class="n">seq</span> <span class="o">=</span> <span class="n">BLayer</span><span class="o">.</span><span class="n">Sequential</span><span class="p">()</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">src_blayer</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>
        <span class="n">seq</span><span class="o">.</span><span class="n">set_name</span><span class="p">(</span><span class="n">src_blayer</span><span class="o">.</span><span class="n">name</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">seq</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">BigDL  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Intel.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>